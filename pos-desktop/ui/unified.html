<!doctype html>
<html lang="en" data-theme="light">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Unified POS (Revamp)</title>
    <link rel="icon" href="/favicon.ico" sizes="any" />
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png" />
    <link rel="icon" type="image/png" sizes="192x192" href="/icon-192.png" />
    <link rel="icon" type="image/png" sizes="512x512" href="/icon-512.png" />
    <link rel="stylesheet" href="/unified.css" />
  </head>
  <body>
    <div class="pageShell">
      <div class="pageGlow" aria-hidden="true"></div>

      <header class="top">
        <div class="brand">
          <div class="titleRow">
            <div class="title">Wholesale POS</div>
            <span class="modePill">Cashier Workspace</span>
          </div>
          <div class="subtitle">Retail FMCG flow: Official + Unofficial split billing, compact layout</div>
          <div class="srOnly" id="status" aria-live="polite"></div>
        </div>
        <div class="controls">
          <label class="pill">
            Checkout Mode
            <select id="invoiceCompany">
              <option value="auto" selected>Auto (Split by item)</option>
              <option value="unofficial">Force Unofficial</option>
              <option value="official">Force Official</option>
            </select>
          </label>
          <button id="syncBtn" class="btn">Sync Both</button>
          <button id="pushBtn" class="btn ghost">Push Both</button>
          <button id="reconnectBothBtn" class="btn ghost">Reconnect</button>
          <button id="themeToggle" class="btn ghost">Dark Theme</button>
          <button id="densityToggle" class="btn ghost">Density: Auto</button>
          <button id="settingsBtn" class="btn ghost">Settings</button>
          <button id="loginBtn" class="btn ghost">Cashier PIN</button>
          <button id="managerBtn" class="btn ghost">Manager</button>
          <div class="edgeBadges">
            <span id="edgeUnofficial" class="edgeBadge edgeUnknown">Unofficial: …</span>
            <span id="edgeOfficial" class="edgeBadge edgeUnknown">Official: …</span>
          </div>
        </div>
      </header>

      <section class="opsBar">
        <div class="opsLeft">
          <span id="statusPill" class="statusPill info" aria-live="polite">Loading…</span>
          <span id="cartSummary" class="factPill">Cart: 0 line(s)</span>
          <span id="activeCustomer" class="factPill">Customer: Guest</span>
          <span id="queueCount" class="factPill">Open Drafts: 0</span>
        </div>
        <div class="opsRight">
          <span class="kbdHint"><kbd>Enter</kbd> add match</span>
          <span class="kbdHint"><kbd>Ctrl/Cmd</kbd> + <kbd>K</kbd> focus scan</span>
          <span class="kbdHint"><kbd>Ctrl/Cmd</kbd> + <kbd>Enter</kbd> pay</span>
        </div>
      </section>

      <main class="workspace">
        <section class="panel panelLeft">
          <div class="panelSection">
            <div class="panelTitle">Draft Workspace</div>
            <div class="opActions">
              <button id="holdBtn" class="btn ghost" type="button">Save Draft</button>
              <button id="openCartBtn" class="btn ghost" type="button">Open Cart</button>
            </div>
          </div>

          <div class="panelSection">
            <div class="panelTitle">Draft Queue</div>
            <div id="orderQueue" class="orderQueue" aria-live="polite"></div>
          </div>
        </section>

        <section class="panel panelCenter">
          <div class="panelHead">
            <div class="panelTitle">Scan / Search Product</div>
            <div class="panelHeadActions">
              <button id="focusScanBtn" class="btn ghost tiny" type="button">Focus Scan</button>
              <button id="clearSearchBtn" class="btn ghost tiny" type="button">Clear</button>
            </div>
          </div>

          <div class="scanRow">
            <input id="scan" type="text" placeholder="Scan barcode or type product name/SKU" autocomplete="off" />
            <button id="addBtn" class="btn">Add</button>
          </div>

          <div class="chipRow" id="searchChips">
            <button class="chip active" type="button" data-filter="all">All</button>
            <button class="chip" type="button" data-filter="quick">Quick add</button>
            <button class="chip" type="button" data-filter="recent">Recent</button>
            <button class="chip" type="button" data-filter="popular">Popular</button>
          </div>

          <div id="scanMeta" class="scanMeta" aria-live="polite">Waiting for input…</div>
          <div class="hint">Tip: scans work anywhere on the screen (no need to click the field).</div>
          <div id="results" class="results"></div>
        </section>

        <section class="panel panelRight">
          <div class="panelHead">
            <div class="panelTitle">Current Sale</div>
            <div class="cartMeta">
              <label class="check">
                <input id="flagOfficial" type="checkbox" />
                Issue as Official (review later)
              </label>
            </div>
          </div>

          <div id="cart" class="cart"></div>

          <div class="totals">
            <div class="row"><span>Items</span><strong id="tItems">0</strong></div>
            <div class="row"><span>Invoice Handling</span><strong id="tInvoiceCompany">Auto</strong></div>
            <div class="row"><span>Subtotal (USD)</span><strong id="tSubtotal">0.00</strong></div>
            <div class="row"><span>VAT (USD)</span><strong id="tVat">0.00</strong></div>
            <div class="row"><span>Total (USD)</span><strong id="tTotal">0.00</strong></div>
            <div id="splitTotals" class="splitTotals hidden" aria-label="Split invoice totals (estimated)">
              <div class="row split"><span>Official total (est.)</span><strong id="tTotalOfficial">0.00</strong></div>
              <div class="row split"><span>Unofficial total (est.)</span><strong id="tTotalUnofficial">0.00</strong></div>
            </div>
          </div>

          <div class="pay">
            <label class="pill">
              Customer ID (optional)
              <input id="customerId" type="text" placeholder="Leave blank for guest" />
            </label>
            <div class="custLookup">
              <input id="customerQuery" type="text" placeholder="Search customer name/phone…" />
              <button id="customerSearchBtn" class="btn ghost">Find</button>
              <button id="customerCreateToggleBtn" class="btn ghost" type="button">New Customer</button>
            </div>
            <div id="customerCreatePanel" class="custCreate hidden">
              <div class="custCreateGrid">
                <input id="customerCreateName" type="text" placeholder="Customer name *" />
                <input id="customerCreatePhone" type="text" placeholder="Phone (optional)" />
                <input id="customerCreateEmail" type="email" placeholder="Email (optional)" />
              </div>
              <div class="custCreateActions">
                <button id="customerCreateBtn" class="btn" type="button">Create Customer</button>
                <button id="customerCreateCancelBtn" class="btn ghost" type="button">Cancel</button>
              </div>
              <div id="customerCreateStatus" class="custCreateStatus" aria-live="polite"></div>
            </div>
            <div id="customerResults" class="custResults"></div>

            <div class="paymentRow">
              <label class="pill">Payment
                <select id="payment">
                  <option value="cash" selected>Cash</option>
                  <option value="card">Card</option>
                  <option value="transfer">Transfer</option>
                  <option value="credit">Credit</option>
                </select>
              </label>
              <div class="payActions">
                <button id="payBtn" class="btn primary">Pay + Print</button>
                <button id="receiptBtn" class="btn ghost">Last Receipt</button>
                <button id="clearCartBtn" class="btn ghost" type="button">Clear</button>
              </div>
            </div>
          </div>
        </section>
      </main>

      <footer class="foot">
        <div class="mono">This page is served by the local POS agent. It coordinates two agents to avoid switching UIs.</div>
      </footer>

      <div id="settingsBackdrop" class="backdrop hidden"></div>
      <div id="settingsModal" class="modal hidden" role="dialog" aria-modal="true" aria-labelledby="settingsTitle">
        <div class="modalHeader">
          <div>
            <h3 id="settingsTitle">POS Connection Settings</h3>
            <p>Use Quick Connect with an approved account, or edit raw config manually. Device token is update-only.</p>
          </div>
        </div>
        <div class="modalBody">
          <section class="cfgCard">
            <h4>Unified UI</h4>
            <label class="cfgField">Other Agent URL<input id="otherAgentUrl" type="text" value="http://localhost:7072" /></label>
          </section>
          <section class="quickCard">
            <h4>Quick Connect</h4>
            <p>Connect with API URL + account, pick company/branch, then register and apply device credentials automatically.</p>
            <div class="quickGrid">
              <label class="cfgField">
                Target Agent
                <select id="quickAgent">
                  <option value="official">Official Agent</option>
                  <option value="unofficial">Unofficial Agent</option>
                </select>
              </label>
              <label class="cfgField">API Base URL<input id="quickApiBaseUrl" type="text" placeholder="https://api.example.com" /></label>
              <label class="cfgField">Email<input id="quickEmail" type="email" placeholder="admin@example.com" autocomplete="username" /></label>
              <label class="cfgField">Password<input id="quickPassword" type="password" placeholder="Password" autocomplete="current-password" /></label>
              <label class="cfgField">MFA Code (if required)<input id="quickMfaCode" type="text" placeholder="123456" inputmode="numeric" /></label>
              <button id="quickSignIn" class="btn" type="button">Sign In</button>
            </div>
            <div class="quickGrid quickGridSecond">
              <label class="cfgField">
                Company
                <select id="quickCompany">
                  <option value="">Select a company...</option>
                </select>
              </label>
              <label class="cfgField">
                Branch (optional)
                <select id="quickBranch">
                  <option value="">None</option>
                </select>
              </label>
              <label class="cfgField">Device Code<input id="quickDeviceCode" type="text" placeholder="POS-01" /></label>
              <div class="cfgField quickCheckField">
                <span>Token Behavior</span>
                <label class="checkInline">
                  <input id="quickResetToken" type="checkbox" checked />
                  Reset token if device already exists
                </label>
              </div>
              <button id="quickApply" class="btn primary" type="button">Register + Apply</button>
            </div>
            <div id="quickStatus" class="quickStatus" aria-live="polite"></div>
          </section>

          <div class="twoCols">
            <section class="cfgCard">
              <h4>Official Agent (Advanced)</h4>
              <label class="cfgField">API Base URL<input id="officialApiBaseUrl" type="text" placeholder="https://api.example.com" /></label>
              <label class="cfgField">Company ID<input id="officialCompanyId" type="text" placeholder="UUID" /></label>
              <label class="cfgField">Branch ID<input id="officialBranchId" type="text" placeholder="UUID (optional)" /></label>
              <label class="cfgField">Device Code<input id="officialDeviceCode" type="text" placeholder="POS-01" /></label>
              <label class="cfgField">Device ID<input id="officialDeviceId" type="text" placeholder="UUID" /></label>
              <label class="cfgField">Device Token (new)<input id="officialDeviceToken" type="password" placeholder="Leave blank to keep current token" /></label>
              <label class="cfgField">Shift ID<input id="officialShiftId" type="text" placeholder="UUID (optional)" /></label>
            </section>
            <section class="cfgCard">
              <h4>Unofficial Agent (Advanced)</h4>
              <label class="cfgField">API Base URL<input id="unofficialApiBaseUrl" type="text" placeholder="https://api.example.com" /></label>
              <label class="cfgField">Company ID<input id="unofficialCompanyId" type="text" placeholder="UUID" /></label>
              <label class="cfgField">Branch ID<input id="unofficialBranchId" type="text" placeholder="UUID (optional)" /></label>
              <label class="cfgField">Device Code<input id="unofficialDeviceCode" type="text" placeholder="POS-02" /></label>
              <label class="cfgField">Device ID<input id="unofficialDeviceId" type="text" placeholder="UUID" /></label>
              <label class="cfgField">Device Token (new)<input id="unofficialDeviceToken" type="password" placeholder="Leave blank to keep current token" /></label>
              <label class="cfgField">Shift ID<input id="unofficialShiftId" type="text" placeholder="UUID (optional)" /></label>
            </section>
          </div>
        </div>
        <div id="settingsStatus" class="modalStatus" aria-live="polite"></div>
        <div class="modalActions">
          <button id="settingsCancel" class="btn ghost" type="button">Cancel</button>
          <button id="settingsSave" class="btn primary" type="button">Save Settings</button>
        </div>
      </div>

      <div id="cartBackdrop" class="backdrop hidden"></div>
      <div id="cartModal" class="modal hidden" role="dialog" aria-modal="true" aria-labelledby="cartTitle">
        <div class="modalHeader">
          <div>
            <h3 id="cartTitle">Cart (Full)</h3>
            <p>Edit quantities and remove items. This view can scroll; the main POS screen stays fixed.</p>
          </div>
        </div>
        <div class="modalBody">
          <div id="cartFull" class="cart cartFull"></div>
        </div>
        <div class="modalActions">
          <button id="cartCloseBtn" class="btn ghost" type="button">Close</button>
        </div>
      </div>

      <div id="managerBackdrop" class="backdrop hidden"></div>
      <div id="managerModal" class="modal hidden" role="dialog" aria-modal="true" aria-labelledby="managerTitle">
        <div class="modalHeader">
          <div>
            <h3 id="managerTitle">Manager Access</h3>
            <p>PIN-gated shortcut for opening the Admin portal on this POS terminal.</p>
          </div>
        </div>
        <div class="modalBody">
          <section class="cfgCard">
            <h4>Admin Portal</h4>
            <label class="cfgField">Admin URL<input id="adminUrl" type="text" placeholder="https://app.melqard.com" /></label>
            <div class="row">
              <button id="adminSuggestBtn" class="btn ghost" type="button">Suggest from API URL</button>
              <button id="adminOpenBtn" class="btn primary" type="button" disabled>Open Admin</button>
            </div>
            <div id="managerStatus" class="quickStatus" aria-live="polite"></div>
          </section>

          <section class="cfgCard">
            <h4>Manager PIN</h4>
            <div class="quickGrid">
              <label class="cfgField">PIN<input id="managerPin" type="password" placeholder="Enter PIN" autocomplete="off" /></label>
              <button id="managerUnlockBtn" class="btn" type="button">Unlock</button>
            </div>
            <div class="quickGrid quickGridSecond">
              <label class="cfgField">Set new PIN<input id="managerPinNew" type="password" placeholder="New PIN" autocomplete="off" /></label>
              <label class="cfgField">Confirm PIN<input id="managerPinNew2" type="password" placeholder="Confirm PIN" autocomplete="off" /></label>
              <button id="managerSetPinBtn" class="btn ghost" type="button">Set PIN</button>
            </div>
            <div class="row">
              <button id="managerLockBtn" class="btn ghost" type="button">Lock</button>
              <button id="managerResetPinBtn" class="btn ghost" type="button">Reset PIN</button>
            </div>
            <p class="muted" style="margin-top: 10px;">
              Note: This is a convenience lock, not a replacement for proper OS user accounts.
            </p>
          </section>
        </div>
      </div>
    </div>

    <script src="/unified.js"></script>
    <script>
      (function uiShellRevamp() {
        if (typeof state === "undefined" || typeof el === "undefined") return;

        const orderQueueLimit = 12;

        if (!Array.isArray(state.ui?.orderQueue)) state.ui.orderQueue = [];
        state.ui.lastOrderSeq = Number(state.ui.lastOrderSeq || 0);

        function cloneTicketLine(line) {
          return {
            key: line?.key || "",
            companyKey: line?.companyKey || "unofficial",
            agentBase: line?.agentBase || "",
            id: line?.id || "",
            sku: line?.sku || "",
            name: line?.name || "",
            barcode: line?.barcode || "",
            price_usd: Number(line?.price_usd || 0),
            price_lbp: Number(line?.price_lbp || 0),
            qty: Number(line?.qty || 0),
          };
        }

        function fmtMoney(v) {
          return Number(v || 0).toFixed(2);
        }

        function formatTicketTime(ts) {
          const d = new Date(Number(ts || Date.now()));
          return `${String(d.getHours()).padStart(2, "0")} : ${String(d.getMinutes()).padStart(2, "0")}`;
        }

        function renderQueueSummary() {
          const queueBadge = el("queueCount");
          if (queueBadge) {
            const len = Array.isArray(state.ui.orderQueue) ? state.ui.orderQueue.length : 0;
            queueBadge.textContent = `Open Drafts: ${len}`;
          }
        }

        function renderOrderQueue() {
          const root = el("orderQueue");
          if (!root) return;

          const list = Array.isArray(state.ui.orderQueue) ? state.ui.orderQueue : [];
          state.ui.orderQueue = list;
          root.innerHTML = "";
          if (!list.length) {
            root.innerHTML = `<div class="queueEmpty">No queued draft sales.</div>`;
            return;
          }

          for (const t of list.slice(0, orderQueueLimit)) {
            const row = document.createElement("div");
            const linesCount = Array.isArray(t.lines) ? t.lines.reduce((sum, line) => sum + Number(line.qty || 0), 0) : 0;
            row.className = `queueItem ${t.status === "Paid" ? "ticketDone" : ""}`;
            row.innerHTML = `
              <div class="queueInfo">
                <div class="queueRowTitle">${escapeHtml(t.code || "Order")}</div>
                <div class="queueMeta">${escapeHtml(t.status || "Open")} · ${formatTicketTime(t.createdAt)} · ${linesCount} item(s) · $${fmtMoney(t.total)}</div>
              </div>
              <div class="queueActions">
                <button type="button" class="btn ghost tiny" data-ticket="${escapeHtml(String(t.id || ""))}" data-action="resume">Load</button>
                <button type="button" class="btn ghost tiny" data-ticket="${escapeHtml(String(t.id || ""))}" data-action="close">Done</button>
              </div>
            `;
            root.appendChild(row);
          }

          root.querySelectorAll("[data-action]").forEach((btn) => {
            btn.addEventListener("click", (event) => {
              const ticketId = String(event.currentTarget?.getAttribute("data-ticket") || "");
              const action = String(event.currentTarget?.getAttribute("data-action") || "");
              if (!ticketId) return;
              if (action === "resume") return resumeQueuedTicket(ticketId);
              if (action === "close") return closeQueuedTicket(ticketId);
            });
          });
        }

        function makeQueueTicket(status, lines) {
          state.ui.lastOrderSeq = Number(state.ui.lastOrderSeq || 0) + 1;
          const total = lines.reduce((sum, line) => sum + Number(line.price_usd || 0) * Number(line.qty || 0), 0);
          return {
            id: `${Date.now()}-${state.ui.lastOrderSeq}`,
            code: `SO-${String(state.ui.lastOrderSeq).padStart(3, "0")}`,
            status,
            createdAt: Date.now(),
            total,
            lines: lines.map(cloneTicketLine),
            customer: state.ui.customerLabel || "Guest",
            invoiceMode: getInvoiceCompany(),
          };
        }

        function queueCurrentOrder(status, clearCart = false) {
          if (!state.cart.length) {
            setStatus("Cart is empty.", "warn");
            return;
          }
          const snapshot = state.cart.map(cloneTicketLine);
          const ticket = makeQueueTicket(status, snapshot);
          state.ui.orderQueue = [ticket, ...state.ui.orderQueue];
          if (state.ui.orderQueue.length > orderQueueLimit) {
            state.ui.orderQueue.length = orderQueueLimit;
          }
          if (clearCart) {
            state.cart = [];
            renderCart();
          }
          renderOrderQueue();
          renderQueueSummary();
          setStatus(`Draft ${ticket.code} ${status.toLowerCase()} saved.`, "ok");
          return ticket;
        }

        function resolveQueueIndex(ticketId) {
          if (!Array.isArray(state.ui.orderQueue)) return -1;
          return state.ui.orderQueue.findIndex((item) => String(item.id || "") === String(ticketId || ""));
        }

        function closeQueuedTicket(ticketId) {
          const i = resolveQueueIndex(ticketId);
          if (i < 0) return;
          state.ui.orderQueue.splice(i, 1);
          renderOrderQueue();
          renderQueueSummary();
          setStatus("Draft removed.", "warn");
        }

        function resumeQueuedTicket(ticketId) {
          const i = resolveQueueIndex(ticketId);
          if (i < 0) return;
          if (state.cart.length) {
            const ok = window.confirm("Replace current cart with this order?");
            if (!ok) return;
          }
          const ticket = state.ui.orderQueue.splice(i, 1)[0];
          const lines = Array.isArray(ticket?.lines) ? ticket.lines : [];
          state.cart = lines.map(cloneTicketLine);
          renderCart();
          renderOrderQueue();
          renderQueueSummary();
          setStatus(`Loaded ${ticket.code} into cart.`, "ok");
        }

        function wrapRenderCart() {
          const originalRenderCart = window.renderCart;
          if (typeof originalRenderCart !== "function") return;
          window.renderCart = function() {
            const r = originalRenderCart.apply(this, arguments);
            renderOrderQueue();
            renderQueueSummary();
            return r;
          };
        }

        function wrapPay() {
          const originalPay = window.pay;
          if (typeof originalPay !== "function") return;
          window.pay = async function() {
            const linesBefore = state.cart.map(cloneTicketLine);
            const totalBefore = linesBefore.reduce((sum, c) => sum + Number(c.price_usd || 0) * Number(c.qty || 0), 0);
            try {
              const res = await originalPay.apply(this, arguments);
              const paid = makeQueueTicket("Paid", linesBefore);
              paid.total = totalBefore;
              paid.status = "Paid";
              state.ui.orderQueue = [paid, ...state.ui.orderQueue];
              if (state.ui.orderQueue.length > orderQueueLimit) {
                state.ui.orderQueue.length = orderQueueLimit;
              }
              renderOrderQueue();
              renderQueueSummary();
              return res;
            } catch (e) {
              throw e;
            }
          };
        }

        function wireRevampControls() {
          el("holdBtn")?.addEventListener("click", () => {
            queueCurrentOrder("Draft", true);
          });
        }

        wireRevampControls();
        renderOrderQueue();
        renderQueueSummary();
        wrapRenderCart();
        wrapPay();
      })();
    </script>
  </body>
</html>
