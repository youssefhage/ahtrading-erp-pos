server {
  listen 80;
  server_name _;

  root /usr/share/nginx/html;
  index index.html;

  # Canonicalize the landing page: always use the "site" UI under /updates/site/*.
  # This avoids having two different landing pages (baked-in vs generated).
  location = / {
    return 307 /updates/site/index.html;
  }
  location = /index.html {
    return 307 /updates/site/index.html;
  }
  location = /style.css {
    return 307 /updates/site/style.css;
  }
  location = /favicon.ico {
    return 307 /updates/site/favicon.ico;
  }
  location = /apple-touch-icon.png {
    return 307 /updates/site/apple-touch-icon.png;
  }
  location = /icon-192.png {
    return 307 /updates/site/icon-192.png;
  }
  location = /icon-512.png {
    return 307 /updates/site/icon-512.png;
  }

  # Download/update artifacts (Tauri update JSON, installers, signatures).
  # We proxy /updates/* to the API service which serves files from its mounted /updates volume.
  # This avoids relying on the downloads container having the volume mount in Dokploy.
  location /updates/ {
    proxy_http_version 1.1;
    # Ensure correct upstream host and TLS SNI.
    proxy_set_header Host app.melqard.com;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;

    proxy_ssl_server_name on;
    proxy_pass https://app.melqard.com/api/updates/;
  }

  location / {
    # Fallback: serve baked-in assets (only used if /updates/* proxy is down).
    try_files $uri $uri/ /index.html;
  }
}
